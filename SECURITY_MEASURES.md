# API Key Manager 安全防护技术文档

本项目已完成从“明文存储脚本”到“生产级安全管理工具”的架构升级。以下是针对 5 大核心安全漏洞（V1-V5）实施的防护措施说明。

## 1. 身份认证机制 (CWE-306)
**防护措施：** 强制性主密码（Master Password）校验。
- **逻辑实现**：在 [main.py](file:///f:/aaa_desktop_file/save-api-key/main.py) 启动阶段强制弹出登录对话框。
- **首次运行检测**：系统会自动检测环境。若为首次运行，将引导用户初始化主密码；非首次运行则强制校验，未通过校验无法访问数据库。

## 2. 静态数据加密存储 (CWE-312)
**防护措施：** 采用工业级 AES-GCM 对称加密算法。
- **密钥派生 (KDF)**：不直接存储密码，而是使用 **PBKDF2-HMAC-SHA256** 算法，结合 16 字节随机盐值（Salt）和 100,000 次哈希迭代派生出 32 字节的加密密钥。
- **存储架构**：
    - `apikeys.db`: 存储经过加密的密文数据。
    - `apikeys.db.salt`: 存储唯一的随机盐值。
    - `apikeys.db.verifier`: 存储加密验证器，用于校验主密码正确性而不泄露原始密码。
- **核心逻辑**：参见 [storage.py](file:///f:/aaa_desktop_file/save-api-key/save_api_key/storage.py) 中的 `_derive_key` 与 `_encrypt` 方法。

## 3. 剪贴板敏感数据保护 (CWE-200)
**防护措施：** 自动清理机制。
- **策略**：当用户点击“复制”获取 API Key 时，程序会启动一个 30 秒的后台计时器。
- **效果**：30 秒后，程序将自动清空系统剪贴板，防止 API Key 长期滞留在剪贴板中被其他恶意程序窃取。

## 4. 输入验证与资源控制 (CWE-400)
**防护措施：** 严格的 Schema 白名单与长度限制。
- **长度硬限制**：
    - Key 长度限制：100 字符。
    - Value (API Key) 长度限制：2000 字符。
    - 备注长度限制：500 字符。
- **输入过滤**：在 [storage.py](file:///f:/aaa_desktop_file/save-api-key/save_api_key/storage.py) 的 `_normalize` 系列方法中对所有输入进行非空检查和去空格处理，杜绝异常数据注入。

## 5. 安全依赖管理 (CWE-1104)
**防护措施：** 锁定高安全等级库版本。
- **依赖库**：引入了 `cryptography>=41.0.0`，该版本修复了多个已知的底层安全漏洞。
- **配置记录**：详细记录于 [requirements.txt](file:///f:/aaa_desktop_file/save-api-key/requirements.txt)。

## 6. 数据存储位置与打包说明
### 存储位置
为了确保数据的持久性和安全性，数据库文件**不会**存储在程序安装目录或 EXE 内部，而是存储在用户的主目录下。

- **默认路径**：`C:\Users\你的用户名\.save_api_key\`
- **文件清单**：
    - `apikeys.db`: 加密数据库主体。
    - `apikeys.db.salt`: 随机盐值文件（关键）。
    - `apikeys.db.verifier`: 密码验证器文件（关键）。

### 打包后的行为 (PyInstaller EXE)
即使你将程序打包成单个 `APIKeyManager.exe`，数据库的行为如下：
- **数据解耦**：EXE 只是运行程序，数据始终留在上述的用户主目录中。
- **便携性说明**：如果你将 EXE 拷贝到另一台电脑运行，程序会因为找不到上述路径下的密钥文件而提示“初始化主密码”。这意味着**你的数据不会随 EXE 泄露**，它安全地留在你的电脑本地。
- **更新不丢数据**：当你替换新的 EXE 版本时，只要用户目录下的文件不删，你的 API Key 数据就会一直保留。

---
**安全声明**：本系统设计遵循“零信任”原则，所有敏感数据在离开内存进入磁盘前均已完成加密。请务必妥善保管您设置的主密码，若主密码丢失，由于加密的不可逆性，数据将无法恢复。
